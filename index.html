<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Workplace Scenario AI Helper</title>
  <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }
    
    body { 
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      min-height: 100vh;
      padding: 20px;
      color: #333;
    }
    
    .container {
      max-width: 800px;
      margin: 0 auto;
      background: rgba(255, 255, 255, 0.95);
      backdrop-filter: blur(10px);
      border-radius: 20px;
      box-shadow: 0 20px 40px rgba(0, 0, 0, 0.1);
      overflow: hidden;
    }
    
    .header {
      background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);
      padding: 40px;
      text-align: center;
      color: white;
    }
    
    .header h1 {
      font-size: 2.5em;
      margin-bottom: 10px;
      font-weight: 600;
    }
    
    .header p {
      font-size: 1.1em;
      opacity: 0.9;
    }
    
    .main-content {
      padding: 40px;
    }
    
    .input-section {
      margin-bottom: 30px;
    }
    
    .input-label {
      display: block;
      margin-bottom: 15px;
      font-weight: 600;
      color: #555;
      font-size: 1.1em;
    }
    
    .input-wrapper {
      position: relative;
      margin-bottom: 20px;
    }
    
    textarea {
      width: 100%;
      height: 150px;
      padding: 20px;
      border: 2px solid #e0e6ed;
      border-radius: 15px;
      font-size: 16px;
      font-family: inherit;
      resize: vertical;
      transition: all 0.3s ease;
      background: #f8fafc;
    }
    
    textarea:focus {
      outline: none;
      border-color: #4facfe;
      background: white;
      transform: translateY(-2px);
      box-shadow: 0 10px 20px rgba(79, 172, 254, 0.2);
    }
    
    .char-counter {
      position: absolute;
      bottom: 10px;
      right: 15px;
      font-size: 12px;
      color: #888;
      background: rgba(255, 255, 255, 0.9);
      padding: 2px 6px;
      border-radius: 10px;
    }
    
    .submit-section {
      text-align: center;
      margin-bottom: 30px;
    }
    
    .submit-btn {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
      padding: 15px 40px;
      border: none;
      border-radius: 50px;
      font-size: 16px;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.3s ease;
      position: relative;
      overflow: hidden;
      min-width: 200px;
    }
    
    .submit-btn:hover:not(:disabled) {
      transform: translateY(-3px);
      box-shadow: 0 15px 30px rgba(102, 126, 234, 0.4);
    }
    
    .submit-btn:disabled {
      opacity: 0.6;
      cursor: not-allowed;
      transform: none;
    }
    
    .submit-btn i {
      margin-right: 8px;
    }
    
    .loading {
      display: none;
      margin-left: 15px;
    }
    
    .loading.active {
      display: inline-block;
    }
    
    .spinner {
      border: 2px solid #f3f3f3;
      border-top: 2px solid #4facfe;
      border-radius: 50%;
      width: 20px;
      height: 20px;
      animation: spin 1s linear infinite;
      display: inline-block;
      vertical-align: middle;
    }
    
    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }
    
    .response {
      margin-top: 30px;
      padding: 30px;
      border-radius: 15px;
      display: none;
      animation: slideUp 0.5s ease;
    }
    
    @keyframes slideUp {
      from {
        opacity: 0;
        transform: translateY(20px);
      }
      to {
        opacity: 1;
        transform: translateY(0);
      }
    }
    
    .response.success {
      background: linear-gradient(135deg, #d4ffd4 0%, #e8f8e8 100%);
      border-left: 5px solid #4caf50;
    }
    
    .response.error {
      background: linear-gradient(135deg, #ffe6e6 0%, #fff0f0 100%);
      border-left: 5px solid #f44336;
    }
    
    .response h2 {
      color: #333;
      margin-bottom: 20px;
      font-size: 1.8em;
      display: flex;
      align-items: center;
    }
    
    .response h2 i {
      margin-right: 10px;
      font-size: 0.8em;
    }
    
    .reply-section {
      background: white;
      padding: 20px;
      border-radius: 10px;
      margin-bottom: 25px;
      line-height: 1.6;
      box-shadow: 0 2px 10px rgba(0, 0, 0, 0.05);
    }
    
    .rules-section h3 {
      color: #555;
      margin-bottom: 15px;
      font-size: 1.4em;
      display: flex;
      align-items: center;
    }
    
    .rules-section h3 i {
      margin-right: 8px;
    }
    
    .rule {
      background: rgba(255, 255, 255, 0.8);
      margin-bottom: 15px;
      padding: 20px;
      border-radius: 10px;
      border-left: 4px solid #4facfe;
      transition: transform 0.2s ease;
    }
    
    .rule:hover {
      transform: translateX(5px);
    }
    
    .rule-title {
      font-weight: 600;
      color: #333;
      margin-bottom: 8px;
      font-size: 1.1em;
    }
    
    .rule-reason {
      color: #666;
      line-height: 1.5;
    }
    
    .debug {
      margin-top: 20px;
      padding: 20px;
      background: #f8f9fa;
      border-radius: 10px;
      border: 1px solid #dee2e6;
      display: none;
    }
    
    .debug.active {
      display: block;
    }
    
    .debug h3 {
      color: #495057;
      margin-bottom: 15px;
      font-size: 1.2em;
    }
    
    .debug-item {
      margin-bottom: 10px;
    }
    
    .debug-label {
      font-weight: 600;
      color: #6c757d;
    }
    
    .debug pre {
      background: #ffffff;
      padding: 15px;
      border-radius: 8px;
      overflow-x: auto;
      font-size: 12px;
      border: 1px solid #e9ecef;
      margin-top: 5px;
    }
    
    .toggle-debug {
      background: transparent;
      border: 1px solid #dee2e6;
      color: #6c757d;
      padding: 8px 16px;
      border-radius: 20px;
      cursor: pointer;
      font-size: 14px;
      margin-top: 15px;
      transition: all 0.3s ease;
    }
    
    .toggle-debug:hover {
      background: #f8f9fa;
      border-color: #adb5bd;
    }
    
    /* Mobile responsiveness */
    @media (max-width: 768px) {
      body {
        padding: 10px;
      }
      
      .header {
        padding: 30px 20px;
      }
      
      .header h1 {
        font-size: 2em;
      }
      
      .main-content {
        padding: 20px;
      }
      
      .submit-btn {
        padding: 12px 30px;
        font-size: 14px;
      }
    }
    
    /* Accessibility improvements */
    @media (prefers-reduced-motion: reduce) {
      *, *::before, *::after {
        animation-duration: 0.01ms !important;
        animation-iteration-count: 1 !important;
        transition-duration: 0.01ms !important;
      }
    }
    
    /* Focus styles for keyboard navigation */
    textarea:focus,
    .submit-btn:focus,
    .toggle-debug:focus {
      outline: 2px solid #4facfe;
      outline-offset: 2px;
    }
  </style>
</head>
<body>
  <div class="container">
    <div class="header">
      <h1><i class="fas fa-brain"></i> Workplace Troubleshooter</h1>
      <p>Empathetic, pragmatic and real world experience rule-based guidance for your workplace challenges</p>
    </div>
    
    <div class="main-content">
      <div class="input-section">
        <label for="scenario" class="input-label">
          <i class="fas fa-pencil-alt"></i> Describe your workplace scenario
        </label>
        <div class="input-wrapper">
          <textarea 
            id="scenario" 
            placeholder="Example: I have a team member who consistently misses deadlines and it's affecting our project deliverables. How should I address this situation professionally?"
            oninput="updateCharCounter()"
          ></textarea>
          <div class="char-counter" id="charCounter">0 characters</div>
        </div>
      </div>
      
      <div class="submit-section">
        <button id="submitBtn" class="submit-btn" onclick="submitScenario()">
          <i class="fas fa-magic"></i> Get Guidance
        </button>
        <div id="loading" class="loading">
          <div class="spinner"></div>
          <span style="margin-left: 10px;">Analyzing scenario...</span>
        </div>
      </div>
      
      <div id="output" class="response">
        <h2 id="responseTitle"><i class="fas fa-lightbulb"></i> Guidance</h2>
        
        <div class="reply-section">
          <div id="reply">Your guidance will appear here...</div>
        </div>
        
        <div class="rules-section">
          <h3><i class="fas fa-list-check"></i> Applied Guidelines</h3>
          <div id="rules">
            <p>No guidelines information available</p>
          </div>
        </div>
        
        <button class="toggle-debug" onclick="toggleDebug()">
          <i class="fas fa-bug"></i> Toggle Debug Info
        </button>
      </div>
      
      <div id="debug" class="debug">
        <h3><i class="fas fa-terminal"></i> Debug Information</h3>
        <div class="debug-item">
          <span class="debug-label">Request URL:</span> <span id="debugUrl"></span>
        </div>
        <div class="debug-item">
          <span class="debug-label">Response Status:</span> <span id="debugStatus"></span>
        </div>
        <div class="debug-item">
          <span class="debug-label">Response Headers:</span>
          <pre id="debugHeaders"></pre>
        </div>
        <div class="debug-item">
          <span class="debug-label">Raw Response:</span>
          <pre id="debugResponse"></pre>
        </div>
      </div>
    </div>
  </div>

  <script> 
    const API_URL = "https://script.google.com/macros/s/AKfycbws1B_0FX-z2lxiKFqGiqcqIABMadbeM72911aEoB2kxWsDalahzGgUcWpGFrw8GjVn6g/exec";
    
    function updateCharCounter() {
      const textarea = document.getElementById("scenario");
      const counter = document.getElementById("charCounter");
      const length = textarea.value.length;
      counter.textContent = `${length} characters`;
      
      // Change color based on length
      if (length > 1000) {
        counter.style.color = '#f44336';
      } else if (length > 500) {
        counter.style.color = '#ff9800';
      } else {
        counter.style.color = '#888';
      }
    }
    
    function toggleDebug() {
      const debug = document.getElementById("debug");
      debug.classList.toggle("active");
    }
    
    async function submitScenario() {
      const scenario = document.getElementById("scenario").value.trim();
      if (!scenario) {
        alert("Please enter a scenario first.");
        return;
      }

      // Reset UI
      const output = document.getElementById("output");
      const loading = document.getElementById("loading");
      const submitBtn = document.getElementById("submitBtn");
      const debug = document.getElementById("debug");
      
      output.style.display = "none";
      debug.classList.remove("active");
      loading.classList.add("active");
      submitBtn.disabled = true;
      submitBtn.innerHTML = '<i class="fas fa-hourglass-half"></i> Processing...';
      
      // Debug info
      document.getElementById("debugUrl").innerText = API_URL;
      
      try {
        console.log("Sending request to:", API_URL);
        console.log("Payload:", { scenario });
        
        // Try GET request first as a fallback for CORS issues
        const useGetFallback = true; // Using GET by default for better CORS compatibility
        
        let res;
        if (useGetFallback) {
          // GET request fallback (encode scenario in URL)
          const encodedScenario = encodeURIComponent(scenario);
          res = await fetch(`${API_URL}?scenario=${encodedScenario}`, {
            method: "GET",
            mode: 'cors'
          });
        } else {
          // Standard POST request
          res = await fetch(API_URL, {
            method: "POST",
            headers: { 
              "Content-Type": "application/json"
            },
            body: JSON.stringify({ scenario }),
            mode: 'cors' // Explicitly set CORS mode
          });
        }
        
        // Debug response info
        document.getElementById("debugStatus").innerText = `${res.status} ${res.statusText}`;
        
        // Get headers for debugging
        const headerText = Array.from(res.headers.entries())
          .map(([key, value]) => `${key}: ${value}`)
          .join('\n');
        document.getElementById("debugHeaders").textContent = headerText || "No headers available";
        
        console.log("Response status:", res.status);
        console.log("Response headers:", headerText);
        
        if (!res.ok) {
          throw new Error(`HTTP error! status: ${res.status}`);
        }
        
        const rawText = await res.text();
        document.getElementById("debugResponse").textContent = rawText;
        console.log("Raw response:", rawText);
        
        let data;
        try {
          data = JSON.parse(rawText);
        } catch (parseError) {
          console.error("JSON parsing error:", parseError);
          throw new Error(`Invalid JSON response: ${rawText.substring(0, 200)}...`);
        }
        
        console.log("Parsed data:", data);
        
        // Handle the case where the server failed to parse the AI response but provided the raw response
        if (data.success === false && data.error === "AI response parsing failed" && data.raw_response) {
          console.log("Server failed to parse AI response, attempting client-side parsing...");
          
          try {
            // Try to parse the raw response on the client side
            const rawResponse = data.raw_response.trim();
            const cleanedResponse = rawResponse.replace(/```json\s*/g, '').replace(/```\s*/g, '');
            const parsedAiResponse = JSON.parse(cleanedResponse);
            
            console.log("Successfully parsed AI response on client side:", parsedAiResponse);
            
            // Use the parsed response as if it came from the server properly
            data = {
              success: true,
              tone_applied: parsedAiResponse.tone_applied,
              reply: parsedAiResponse.reply,
              rules_used: parsedAiResponse.rules_used
            };
            
          } catch (clientParseError) {
            console.error("Client-side parsing also failed:", clientParseError);
            throw new Error(`Server error: ${data.error || 'Unknown error'}`);
          }
        }
        
        // Handle the new response format with success wrapper
        if (data.success === false) {
          throw new Error(`Server error: ${data.error || 'Unknown error'}`);
        }
        
        // Handle both old format (direct fields) and new format (with success wrapper)
        let responseData;
        if (data.success === true) {
          // New format: { success: true, tone_applied: ..., reply: ..., rules_used: ... }
          responseData = data;
        } else if (data.tone_applied || data.reply || data.rules_used) {
          // Old format: { tone_applied: ..., reply: ..., rules_used: ... }
          responseData = data;
        } else {
          throw new Error("Response does not contain expected data structure");
        }
        
        // Update UI with successful response
        // document.getElementById("tone").innerText = responseData.tone_applied || "Not specified";
        document.getElementById("reply").innerText = responseData.reply || "No reply received";
        
        const rulesDiv = document.getElementById("rules");
        rulesDiv.innerHTML = "";
        
        if (responseData.rules_used && Array.isArray(responseData.rules_used) && responseData.rules_used.length > 0) {
          responseData.rules_used.forEach(rule => {
            const div = document.createElement("div");
            div.className = "rule";
            div.innerHTML = `
              <div class="rule-title">${rule.title || 'Untitled Rule'}</div>
              <div class="rule-reason">${rule.reason || 'No reason provided'}</div>
            `;
            rulesDiv.appendChild(div);
          });
        } else {
          rulesDiv.innerHTML = "<p>No specific guidelines were applied to this scenario.</p>";
        }
        
        output.className = "response success";
        output.style.display = "block";
        document.getElementById("responseTitle").innerHTML = '<i class="fas fa-check-circle"></i> AI Guidance';
        
      } catch (error) {
        console.error("Error:", error);
        
        // Show error in UI
        document.getElementById("output").innerHTML = `
          <h2><i class="fas fa-exclamation-triangle"></i> Error</h2>
          <div class="reply-section">
            <p><strong>Error Message:</strong> ${error.message}</p>
            <p>Please check the debug information below and browser console for more details.</p>
          </div>
        `;
        document.getElementById("output").className = "response error";
        document.getElementById("output").style.display = "block";
        
        // Show debug info on error
        document.getElementById("debug").classList.add("active");
      } finally {
        loading.classList.remove("active");
        submitBtn.disabled = false;
        submitBtn.innerHTML = '<i class="fas fa-magic"></i> Get AI Guidance';
      }
    }
    
    // Optional: Test the endpoint on page load
    window.addEventListener('load', function() {
      console.log("Page loaded. API endpoint:", API_URL);
      
      // Test if the endpoint is reachable with a simple GET request
      fetch(API_URL, { method: 'GET' })
        .then(res => {
          console.log("GET test response status:", res.status);
          return res.text();
        })
        .then(text => {
          console.log("GET test response:", text.substring(0, 200));
        })
        .catch(err => {
          console.log("GET test failed (this might be expected if your script only accepts POST):", err.message);
        });
    });
    
    // Allow Enter key to submit (with Shift+Enter for new lines)
    document.getElementById('scenario').addEventListener('keydown', function(e) {
      if (e.key === 'Enter' && !e.shiftKey) {
        e.preventDefault();
        submitScenario();
      }
    });
  </script>
</body>
</html>
