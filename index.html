<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Workplace Scenario AI Helper</title>
  <style>
    body { font-family: Arial, sans-serif; margin: 20px; max-width: 700px; }
    h1 { font-size: 1.5em; }
    textarea { width: 100%; height: 120px; margin-bottom: 10px; padding: 10px; }
    button { padding: 10px 20px; cursor: pointer; }
    button:disabled { background: #ccc; cursor: not-allowed; }
    .response { margin-top: 20px; padding: 15px; background: #f8f8f8; border-radius: 8px; }
    .error { background: #ffe6e6; border: 1px solid #ff9999; color: #cc0000; }
    .success { background: #e6ffe6; border: 1px solid #99ff99; color: #006600; }
    .rule { margin-bottom: 10px; }
    .rule-title { font-weight: bold; }
    .debug { margin-top: 20px; padding: 15px; background: #fff; border: 1px solid #ddd; border-radius: 8px; }
    .debug pre { background: #f5f5f5; padding: 10px; overflow-x: auto; font-size: 12px; }
    .loading { display: inline-block; margin-left: 10px; }
  </style>
</head>
<body>
  <h1>Workplace Scenario AI Helper</h1>
  <p>Type in your workplace scenario below and get an AI-generated, rule-based reply.</p>
  <textarea id="scenario" placeholder="Describe your scenario here..."></textarea>
  <br/>
  <button id="submitBtn" onclick="submitScenario()">Get AI Reply</button>
  <span id="loading" class="loading" style="display:none;">Processing...</span>
  
  <div id="output" class="response" style="display:none;">
    <h2>AI Reply</h2>
    <p><strong>Tone Applied:</strong> <span id="tone"></span></p>
    <p id="reply"></p>
    <h3>Rules Applied</h3>
    <div id="rules"></div>
  </div>
  
  <div id="debug" class="debug" style="display:none;">
    <h3>Debug Information</h3>
    <p><strong>Request URL:</strong> <span id="debugUrl"></span></p>
    <p><strong>Response Status:</strong> <span id="debugStatus"></span></p>
    <p><strong>Response Headers:</strong></p>
    <pre id="debugHeaders"></pre>
    <p><strong>Raw Response:</strong></p>
    <pre id="debugResponse"></pre>
  </div>

  <script>
    const API_URL = "https://script.google.com/macros/s/AKfycbxliVbxrxW49ch7mAoK5GhLmSvGkWZ0ndjqV32HE8v5m3vNiJaDB_FG45nBZZFJE2RHyw/exec";
    
    async function submitScenario() {
      const scenario = document.getElementById("scenario").value.trim();
      if (!scenario) {
        alert("Please enter a scenario first.");
        return;
      }

      // Reset UI
      document.getElementById("output").style.display = "none";
      document.getElementById("debug").style.display = "none";
      document.getElementById("loading").style.display = "inline";
      document.getElementById("submitBtn").disabled = true;
      
      // Debug info
      document.getElementById("debugUrl").innerText = API_URL;
      
      try {
        console.log("Sending request to:", API_URL);
        console.log("Payload:", { scenario });
        
        const res = await fetch(API_URL, {
          method: "POST",
          headers: { 
            "Content-Type": "application/json"
          },
          body: JSON.stringify({ scenario }),
          mode: 'cors' // Explicitly set CORS mode
        });
        
        // Debug response info
        document.getElementById("debugStatus").innerText = `${res.status} ${res.statusText}`;
        
        // Get headers for debugging
        const headerText = Array.from(res.headers.entries())
          .map(([key, value]) => `${key}: ${value}`)
          .join('\n');
        document.getElementById("debugHeaders").textContent = headerText || "No headers available";
        
        console.log("Response status:", res.status);
        console.log("Response headers:", headerText);
        
        if (!res.ok) {
          throw new Error(`HTTP error! status: ${res.status}`);
        }
        
        const rawText = await res.text();
        document.getElementById("debugResponse").textContent = rawText;
        console.log("Raw response:", rawText);
        
        let data;
        try {
          data = JSON.parse(rawText);
        } catch (parseError) {
          console.error("JSON parsing error:", parseError);
          throw new Error(`Invalid JSON response: ${rawText.substring(0, 200)}...`);
        }
        
        console.log("Parsed data:", data);
        
        // Check if the response has the expected structure
        if (!data || typeof data !== 'object') {
          throw new Error("Response is not a valid object");
        }
        
        // Handle the new response format with success wrapper
        if (data.success === false) {
          throw new Error(`Server error: ${data.error || 'Unknown error'}`);
        }
        
        // Handle both old format (direct fields) and new format (with success wrapper)
        let responseData;
        if (data.success === true) {
          // New format: { success: true, tone_applied: ..., reply: ..., rules_used: ... }
          responseData = data;
        } else if (data.tone_applied || data.reply || data.rules_used) {
          // Old format: { tone_applied: ..., reply: ..., rules_used: ... }
          responseData = data;
        } else {
          throw new Error("Response does not contain expected data structure");
        }
        
        // Update UI with successful response
        document.getElementById("tone").innerText = responseData.tone_applied || "Not specified";
        document.getElementById("reply").innerText = responseData.reply || "No reply received";
        
        const rulesDiv = document.getElementById("rules");
        rulesDiv.innerHTML = "";
        
        if (responseData.rules_used && Array.isArray(responseData.rules_used)) {
          responseData.rules_used.forEach(rule => {
            const div = document.createElement("div");
            div.className = "rule";
            div.innerHTML = `<div class="rule-title">${rule.title || 'Untitled Rule'}</div><div>${rule.reason || 'No reason provided'}</div>`;
            rulesDiv.appendChild(div);
          });
        } else {
          rulesDiv.innerHTML = "<p>No rules information available</p>";
        }
        
        document.getElementById("output").style.display = "block";
        document.getElementById("output").className = "response success";
        
      } catch (error) {
        console.error("Error:", error);
        
        // Show error in UI
        document.getElementById("output").innerHTML = `
          <h2>Error</h2>
          <p><strong>Error Message:</strong> ${error.message}</p>
          <p>Please check the debug information below and browser console for more details.</p>
        `;
        document.getElementById("output").className = "response error";
        document.getElementById("output").style.display = "block";
        
        // Always show debug info on error
        document.getElementById("debug").style.display = "block";
      } finally {
        document.getElementById("loading").style.display = "none";
        document.getElementById("submitBtn").disabled = false;
      }
    }
    
    // Optional: Test the endpoint on page load
    window.addEventListener('load', function() {
      console.log("Page loaded. API endpoint:", API_URL);
      
      // Test if the endpoint is reachable with a simple GET request
      fetch(API_URL, { method: 'GET' })
        .then(res => {
          console.log("GET test response status:", res.status);
          return res.text();
        })
        .then(text => {
          console.log("GET test response:", text.substring(0, 200));
        })
        .catch(err => {
          console.log("GET test failed (this might be expected if your script only accepts POST):", err.message);
        });
    });
  </script>
</body>
</html>
