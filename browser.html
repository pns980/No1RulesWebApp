<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>No. 1 Rules Browser</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
            line-height: 1.6;
        }
        
        .container {
            max-width: 1400px;
            margin: 0 auto;
        }
        
        .header {
            text-align: center;
            margin-bottom: 3rem;
        }
        
        h1 {
            color: white;
            font-size: 3.5rem;
            margin-bottom: 1rem;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.3);
            font-weight: 300;
        }
        
        .subtitle {
            color: rgba(255,255,255,0.9);
            font-size: 1.3rem;
            margin-bottom: 2rem;
            font-weight: 300;
        }
        
        .controls {
            background: rgba(255,255,255,0.1);
            backdrop-filter: blur(15px);
            border-radius: 20px;
            padding: 30px;
            margin-bottom: 40px;
            border: 1px solid rgba(255,255,255,0.2);
            box-shadow: 0 8px 32px rgba(0,0,0,0.1);
        }
        
        .search-box {
            width: 100%;
            max-width: 600px;
            margin: 0 auto 30px;
            display: block;
            padding: 18px 25px;
            border: none;
            border-radius: 30px;
            font-size: 16px;
            background: rgba(255,255,255,0.95);
            box-shadow: 0 4px 20px rgba(0,0,0,0.1);
            outline: none;
            transition: all 0.3s ease;
        }
        
        .search-box:focus {
            transform: translateY(-2px);
            box-shadow: 0 6px 25px rgba(0,0,0,0.15);
        }
        
        .filter-section {
            margin-bottom: 25px;
        }
        
        .filter-title {
            color: rgba(255,255,255,0.9);
            font-size: 16px;
            font-weight: 600;
            margin-bottom: 12px;
            text-transform: uppercase;
            letter-spacing: 1px;
        }
        
        .filter-group {
            display: flex;
            flex-wrap: wrap;
            gap: 12px;
            justify-content: center;
        }
        
        .filter-btn {
            background: rgba(255,255,255,0.15);
            color: rgba(255,255,255,0.9);
            border: 2px solid rgba(255,255,255,0.3);
            padding: 12px 24px;
            border-radius: 25px;
            cursor: pointer;
            transition: all 0.3s ease;
            font-size: 14px;
            font-weight: 500;
            text-transform: capitalize;
            min-width: 120px;
            text-align: center;
        }
        
        .filter-btn:hover {
            background: rgba(255,255,255,0.25);
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(0,0,0,0.2);
        }
        
        .filter-btn.active {
            background: rgba(255,255,255,0.9);
            color: #667eea;
            border-color: rgba(255,255,255,0.9);
            font-weight: 600;
        }
        
        .stats {
            text-align: center;
            color: rgba(255,255,255,0.8);
            margin: 20px 0;
            font-size: 14px;
            font-weight: 300;
        }
        
        .rules-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(380px, 1fr));
            gap: 30px;
            margin-top: 30px;
        }
        
        .rule-card {
            background: rgba(255,255,255,0.95);
            border-radius: 20px;
            padding: 30px;
            box-shadow: 0 10px 40px rgba(0,0,0,0.1);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255,255,255,0.3);
            transition: all 0.4s ease;
            position: relative;
            overflow: hidden;
        }
        
        .rule-card:hover {
            transform: translateY(-8px);
            box-shadow: 0 20px 50px rgba(0,0,0,0.15);
        }
        
        .rule-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 5px;
            background: linear-gradient(90deg, #667eea, #764ba2);
        }
        
        .tags-container {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
            margin-bottom: 20px;
        }
        
        .tag {
            display: inline-block;
            padding: 6px 12px;
            border-radius: 15px;
            font-size: 11px;
            font-weight: bold;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }
        
        .tag.area {
            background: linear-gradient(135deg, #ff6b6b, #ee5a52);
            color: white;
        }
        
        .tag.discipline {
            background: linear-gradient(135deg, #4ecdc4, #44a08d);
            color: white;
        }
        
        .tag.skill {
            background: linear-gradient(135deg, #45b7d1, #96c93d);
            color: white;
        }
        
        .rule-title {
            font-size: 1.4rem;
            font-weight: 700;
            color: #2c3e50;
            margin-bottom: 15px;
            line-height: 1.3;
        }
        
        .rule-description {
            color: #5a6c7d;
            line-height: 1.7;
            font-size: 14px;
            text-align: justify;
            margin-bottom: 15px;
            display: none;
        }
        
        .read-more-btn {
            background: linear-gradient(135deg, #667eea, #764ba2);
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 20px;
            cursor: pointer;
            font-size: 13px;
            font-weight: 500;
            transition: all 0.3s ease;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }
        
        .read-more-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 15px rgba(102, 126, 234, 0.4);
        }
        
        .read-more-btn.collapse {
            background: linear-gradient(135deg, #ff6b6b, #ee5a52);
        }
        
        .no-results {
            text-align: center;
            color: rgba(255,255,255,0.8);
            font-size: 1.4rem;
            margin-top: 80px;
            display: none;
            padding: 40px;
            background: rgba(255,255,255,0.1);
            border-radius: 20px;
            backdrop-filter: blur(10px);
        }
        
        .reset-filters {
            display: block;
            margin: 20px auto;
            background: rgba(255,255,255,0.2);
            color: white;
            border: 2px solid rgba(255,255,255,0.4);
            padding: 12px 30px;
            border-radius: 25px;
            cursor: pointer;
            transition: all 0.3s ease;
            font-size: 14px;
            font-weight: 500;
        }
        
        .reset-filters:hover {
            background: rgba(255,255,255,0.3);
            transform: translateY(-2px);
        }
        
        .loading {
            text-align: center;
            color: rgba(255,255,255,0.8);
            padding: 60px;
            font-size: 1.2rem;
        }
        
        .loading-spinner {
            font-size: 2rem;
            margin-bottom: 1rem;
            animation: spin 2s linear infinite;
        }
        
        @keyframes spin {
            from { transform: rotate(0deg); }
            to { transform: rotate(360deg); }
        }
        
        @media (max-width: 768px) {
            h1 {
                font-size: 2.5rem;
            }
            
            .rules-grid {
                grid-template-columns: 1fr;
                gap: 20px;
            }
            
            .controls {
                padding: 20px;
            }
            
            .filter-group {
                justify-content: center;
            }
            
            .filter-btn {
                min-width: 100px;
                padding: 10px 18px;
                font-size: 12px;
            }
            
            .rule-card {
                padding: 25px;
            }
            
            .rule-title {
                font-size: 1.2rem;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>📋 No. 1 Rules</h1>
            <p class="subtitle">100 practical rules for managing people, business, and yourself</p>
        </div>
        
        <div class="controls">
            <input type="text" id="searchBox" class="search-box" placeholder="Search rules by title or content...">
            
            <div class="filter-section">
                <div class="filter-title">Area</div>
                <div class="filter-group" id="areaFilters"></div>
            </div>
            
            <div class="filter-section">
                <div class="filter-title">Discipline</div>
                <div class="filter-group" id="disciplineFilters"></div>
            </div>
            
            <div class="filter-section">
                <div class="filter-title">Skill</div>
                <div class="filter-group" id="skillFilters"></div>
            </div>
            
            <button class="reset-filters" onclick="resetAllFilters()">🔄 Reset All Filters</button>
            
            <div class="stats" id="stats"></div>
        </div>
        
        <div class="rules-grid" id="rulesGrid"></div>
        <div class="no-results" id="noResults">
            <h3>No rules found matching your criteria.</h3>
            <p>Try adjusting your search or filters.</p>
        </div>
    </div>

    <script>
        const SCRIPT_URL = 'https://script.google.com/macros/s/AKfycbw6qXXzzJj-5ulyAqOBxL33j8CyUc9CiVxl3sD15ItgbHRhF-z5FLFxsY7Ue8b1Gd2t/exec';
        
        let rulesData = [];
        let filteredRules = [];
        let activeFilters = { area: 'all', discipline: 'all', skill: 'all' };

        const fallbackData = [
            {
                title: "Think for yourself.",
                fullDescription: "No №1 Rule carries more irony and universality as this one which basically says that there are no universal rules, no forever truths. Each of us is right for themselves at each given moment, even if we contradict ourselves from a moment ago. There's no universal judge to deliberate and guide us but our internal moral compass. It may sound liberating, but I see it as the ultimate burden of responsibility.",
                area: "Self",
                discipline: "Perception",
                skill: "Analytical skills"
            },
            {
                title: "You can't improve what you can't measure",
                fullDescription: "A brief story from professional experience: After 4-5 relatively flat years, we broke the barrier and returned to steady growth mode. What changed? We finally set up measurements of utilization, revenue per capita, receivables, etc. What aspects of your habits, skills, personal life or business do you believe are worth enhancing? Make measurement the initial step toward reaching the next level of improvement.",
                area: "Business",
                discipline: "Action",
                skill: "Analytical skills"
            },
            {
                title: "Beliefs and values: Do not touch",
                fullDescription: "You want to invest your time in meaningful conversation. This happens when there's a high rapport and high level of challenge. Once those are in place, focus on observable behaviors. Feel free to comment and influence those. There are areas, however, where it is none of your business to invite yourself. Specifically, do NOT attempt to comment on or alter beliefs and values.",
                area: "People",
                discipline: "Action",
                skill: "Communication"
            },
            {
                title: "Do not assume - ask",
                fullDescription: "We make thousands of assumptions each day about people, events, ideas, etc. It's a pre-programmed shortcut that often involves archetypes or beliefs because being objective is costly and hard. Be mindful of your assumptions and if you catch yourself doing it in an important context, rather than rolling with it - ask directly.",
                area: "Business",
                discipline: "Action",
                skill: "Communication"
            },
            {
                title: "People first, always",
                fullDescription: "Most days at work will overflow with tasks competing for your attention. If you've ever uttered the words 'we're a people-oriented business' - there's little choice but to always prioritize matters of people. If a team member comes to you in real trouble everything should stop.",
                area: "Business",
                discipline: "Action",
                skill: "Leadership"
            }
        ];

        function showLoading() {
            document.getElementById('rulesGrid').innerHTML = `
                <div class="loading">
                    <div class="loading-spinner">📊</div>
                    <div>Loading your rules from Google Sheets...</div>
                    <div style="font-size: 0.9rem; margin-top: 10px; opacity: 0.7;">This may take a few seconds</div>
                </div>
            `;
        }

        function loadDataWithJSONP() {
            return new Promise((resolve, reject) => {
                console.log('📡 Loading data via JSONP from:', SCRIPT_URL);
                
                const callbackName = 'jsonp_callback_' + Math.round(100000 * Math.random());
                const timestamp = Date.now();
                
                const timeoutId = setTimeout(() => {
                    console.error('⏰ JSONP request timeout');
                    cleanup();
                    reject(new Error('Request timeout - please check your internet connection'));
                }, 15000);
                
                // Define the global callback function
                window[callbackName] = function(data) {
                    console.log('✅ JSONP callback received data:', data);
                    cleanup();
                    resolve(data);
                };
                
                function cleanup() {
                    clearTimeout(timeoutId);
                    if (script && script.parentNode) {
                        script.parentNode.removeChild(script);
                    }
                    if (window[callbackName]) {
                        delete window[callbackName];
                    }
                }
                
                const script = document.createElement('script');
                
                script.onerror = function(error) {
                    console.error('❌ JSONP script loading failed:', error);
                    cleanup();
                    reject(new Error('Failed to load data from Google Sheets'));
                };
                
                script.onload = function() {
                    console.log('📜 JSONP script loaded successfully');
                    // Callback should fire automatically, but add a backup timeout
                    setTimeout(() => {
                        if (window[callbackName]) {
                            console.warn('⚠️  Callback not fired, timing out...');
                            cleanup();
                            reject(new Error('Callback not received from server'));
                        }
                    }, 10000);
                };
                
                const scriptUrl = `${SCRIPT_URL}?callback=${callbackName}&_=${timestamp}`;
                console.log('🔗 Loading script:', scriptUrl);
                
                script.src = scriptUrl;
                document.head.appendChild(script);
            });
        }

        async function loadData() {
            showLoading();
            
            try {
                const data = await loadDataWithJSONP();
                
                if (Array.isArray(data) && data.length > 0) {
                    rulesData = data;
                    
                    document.getElementById('stats').innerHTML = `
                        <div style="background: rgba(40, 167, 69, 0.2); color: rgba(255,255,255,0.95); padding: 15px; border-radius: 15px; margin: 15px 0; text-align: center;">
                            Successfully loaded ${data.length} rules from Google Sheets!
                        </div>
                    `;
                } else {
                    throw new Error('No data received or invalid data format');
                }
                
            } catch (error) {
                rulesData = fallbackData;
                
                document.getElementById('stats').innerHTML = `
                    <div style="background: rgba(255, 193, 7, 0.2); color: rgba(255,255,255,0.95); padding: 15px; border-radius: 15px; margin: 15px 0; text-align: center;">
                        Could not load from Google Sheets: ${error.message}<br>
                        <small style="opacity: 0.8;">Showing ${fallbackData.length} sample rules instead.</small>
                    </div>
                `;
            }
            
            filteredRules = [...rulesData];
            init();
        }

        function init() {
            createFilters();
            render();
            updateStats();
            document.getElementById('searchBox').addEventListener('input', applyFilters);
        }

        function createFilters() {
            // Static filter values as defined
            const areas = ['all', 'people', 'self', 'business'];
            const disciplines = ['all', 'perception', 'will', 'action'];
            const skills = ['all', 'communication', 'teamwork', 'analytical skills', 'empathy', 'work ethic', 'leadership', 'self-management'];

            document.getElementById('areaFilters').innerHTML = areas.map(area => 
                `<button class="filter-btn ${area === 'all' ? 'active' : ''}" onclick="filterByArea('${area}')">
                    ${area === 'all' ? 'All Areas' : capitalizeFirst(area)}
                </button>`
            ).join('');

            document.getElementById('disciplineFilters').innerHTML = disciplines.map(discipline => 
                `<button class="filter-btn ${discipline === 'all' ? 'active' : ''}" onclick="filterByDiscipline('${discipline}')">
                    ${discipline === 'all' ? 'All Disciplines' : capitalizeFirst(discipline)}
                </button>`
            ).join('');

            document.getElementById('skillFilters').innerHTML = skills.map(skill => 
                `<button class="filter-btn ${skill === 'all' ? 'active' : ''}" onclick="filterBySkill('${skill}')">
                    ${skill === 'all' ? 'All Skills' : capitalizeFirst(skill)}
                </button>`
            ).join('');
        }

        function capitalizeFirst(str) {
            return str.charAt(0).toUpperCase() + str.slice(1);
        }

        function filterByArea(area) {
            activeFilters.area = area;
            updateButtons('areaFilters', area);
            applyFilters();
        }

        function filterByDiscipline(discipline) {
            activeFilters.discipline = discipline;
            updateButtons('disciplineFilters', discipline);
            applyFilters();
        }

        function filterBySkill(skill) {
            activeFilters.skill = skill;
            updateButtons('skillFilters', skill);
            applyFilters();
        }

        function updateButtons(containerId, activeValue) {
            const container = document.getElementById(containerId);
            container.querySelectorAll('.filter-btn').forEach(btn => {
                btn.classList.remove('active');
                const btnValue = btn.getAttribute('onclick').match(/'([^']+)'/)[1];
                if (btnValue === activeValue) {
                    btn.classList.add('active');
                }
            });
        }

        function resetAllFilters() {
            activeFilters = { area: 'all', discipline: 'all', skill: 'all' };
            document.getElementById('searchBox').value = '';
            document.querySelectorAll('.filter-btn').forEach(btn => {
                btn.classList.toggle('active', btn.textContent.toLowerCase().includes('all'));
            });
            applyFilters();
        }

        function applyFilters() {
            const searchTerm = document.getElementById('searchBox').value.toLowerCase();
            
            console.log('🔍 Applying filters:', { 
                search: searchTerm, 
                area: activeFilters.area, 
                discipline: activeFilters.discipline, 
                skill: activeFilters.skill 
            });
            
            filteredRules = rulesData.filter(rule => {
                const matchesSearch = !searchTerm || 
                    rule.title.toLowerCase().includes(searchTerm) || 
                    rule.fullDescription.toLowerCase().includes(searchTerm);

                // Debug log for first few items
                if (rulesData.indexOf(rule) < 3) {
                    console.log(`🔍 Rule ${rulesData.indexOf(rule)}:`, {
                        title: rule.title,
                        area: rule.area,
                        discipline: rule.discipline,
                        skill: rule.skill
                    });
                }

                // Area can have multiple values separated by semicolons
                let matchesArea = activeFilters.area === 'all';
                if (!matchesArea && rule.area) {
                    const ruleAreas = rule.area.toLowerCase().split(';').map(a => a.trim());
                    matchesArea = ruleAreas.includes(activeFilters.area.toLowerCase());
                    console.log(`Area check: ${activeFilters.area} in [${ruleAreas.join(', ')}] = ${matchesArea}`);
                }

                // Discipline is a single value
                let matchesDiscipline = activeFilters.discipline === 'all';
                if (!matchesDiscipline && rule.discipline) {
                    matchesDiscipline = rule.discipline.toLowerCase().trim() === activeFilters.discipline.toLowerCase();
                    console.log(`Discipline check: "${rule.discipline.toLowerCase().trim()}" === "${activeFilters.discipline.toLowerCase()}" = ${matchesDiscipline}`);
                }

                // Skill is a single value
                let matchesSkill = activeFilters.skill === 'all';
                if (!matchesSkill && rule.skill) {
                    matchesSkill = rule.skill.toLowerCase().trim() === activeFilters.skill.toLowerCase();
                    console.log(`Skill check: "${rule.skill.toLowerCase().trim()}" === "${activeFilters.skill.toLowerCase()}" = ${matchesSkill}`);
                }
                
                const matches = matchesSearch && matchesArea && matchesDiscipline && matchesSkill;
                
                if (rulesData.indexOf(rule) < 3) {
                    console.log(`Rule ${rulesData.indexOf(rule)} matches:`, {
                        search: matchesSearch,
                        area: matchesArea,
                        discipline: matchesDiscipline,
                        skill: matchesSkill,
                        overall: matches
                    });
                }
                
                return matches;
            });
            
            console.log(`📊 Filtered from ${rulesData.length} to ${filteredRules.length} rules`);
            render();
            updateStats();
        }

        function render() {
            const grid = document.getElementById('rulesGrid');
            const noResults = document.getElementById('noResults');
            
            if (filteredRules.length === 0) {
                grid.style.display = 'none';
                noResults.style.display = 'block';
            } else {
                grid.style.display = 'grid';
                noResults.style.display = 'none';
                
                grid.innerHTML = filteredRules.map((rule, index) => {
                    // Debug: Log what we're trying to render
                    if (index < 3) {
                        console.log(`🎨 Rendering rule ${index}:`, {
                            title: rule.title,
                            area: rule.area,
                            discipline: rule.discipline,
                            skill: rule.skill
                        });
                    }
                    
                    // Handle area - can be multiple values
                    const areas = rule.area ? rule.area.split(';').map(a => a.trim()) : ['Unknown'];
                    const areaTag = areas[0] || 'Unknown';
                    
                    // Handle discipline - should be single value
                    const discipline = rule.discipline ? rule.discipline.trim() : 'Unknown';
                    
                    // Handle skill - should be single value
                    const skill = rule.skill ? rule.skill.trim() : 'Unknown';
                    
                    return `
                        <div class="rule-card">
                            <div class="tags-container">
                                <span class="tag area">${areaTag}</span>
                                <span class="tag discipline">${discipline}</span>
                                <span class="tag skill">${skill}</span>
                            </div>
                            <h3 class="rule-title">${rule.title || 'Untitled'}</h3>
                            <div class="rule-description" id="desc-${index}">
                                ${rule.fullDescription || 'No description available.'}
                            </div>
                            <button class="read-more-btn" onclick="toggle(${index})" id="btn-${index}">
                                Read More
                            </button>
                        </div>
                    `;
                }).join('');
            }
        }

        function toggle(index) {
            const desc = document.getElementById(`desc-${index}`);
            const btn = document.getElementById(`btn-${index}`);
            
            if (desc.style.display === 'none' || desc.style.display === '') {
                desc.style.display = 'block';
                btn.textContent = 'Show Less';
                btn.classList.add('collapse');
            } else {
                desc.style.display = 'none';
                btn.textContent = 'Read More';
                btn.classList.remove('collapse');
            }
        }

        function updateStats() {
            const currentStats = document.getElementById('stats');
            const statsText = `Showing ${filteredRules.length} of ${rulesData.length} rules`;
            
            // Only update if it's not showing the success/error message
            if (!currentStats.innerHTML.includes('✅') && !currentStats.innerHTML.includes('⚠️')) {
                currentStats.textContent = statsText;
            }
        }

        document.addEventListener('DOMContentLoaded', loadData);
    </script>
</body>
</html>
