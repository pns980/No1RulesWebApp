<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>No. 1 Rules Browser - Diagnostic</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
            line-height: 1.6;
        }
        
        .container {
            max-width: 1400px;
            margin: 0 auto;
        }
        
        .header {
            text-align: center;
            margin-bottom: 3rem;
        }
        
        h1 {
            color: white;
            font-size: 3.5rem;
            margin-bottom: 1rem;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.3);
            font-weight: 300;
        }
        
        .subtitle {
            color: rgba(255,255,255,0.9);
            font-size: 1.3rem;
            margin-bottom: 2rem;
            font-weight: 300;
        }
        
        .diagnostic-panel {
            background: rgba(255,255,255,0.1);
            backdrop-filter: blur(15px);
            border-radius: 20px;
            padding: 30px;
            margin-bottom: 40px;
            border: 1px solid rgba(255,255,255,0.2);
            box-shadow: 0 8px 32px rgba(0,0,0,0.1);
            color: white;
        }
        
        .diagnostic-title {
            font-size: 24px;
            margin-bottom: 20px;
            color: #4ecdc4;
        }
        
        .test-section {
            background: rgba(255,255,255,0.05);
            padding: 20px;
            border-radius: 15px;
            margin-bottom: 20px;
        }
        
        .test-section h3 {
            color: #45b7d1;
            margin-bottom: 15px;
        }
        
        .url-input {
            width: 100%;
            max-width: 600px;
            padding: 12px;
            border: none;
            border-radius: 20px;
            margin-bottom: 15px;
            font-size: 14px;
        }
        
        .btn {
            background: linear-gradient(135deg, #667eea, #764ba2);
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 20px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 500;
            margin: 5px;
            transition: all 0.3s ease;
        }
        
        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 15px rgba(102, 126, 234, 0.4);
        }
        
        .btn.secondary {
            background: rgba(255,255,255,0.2);
        }
        
        .log {
            background: rgba(0,0,0,0.3);
            padding: 15px;
            border-radius: 10px;
            font-family: 'Courier New', monospace;
            font-size: 12px;
            max-height: 300px;
            overflow-y: auto;
            white-space: pre-wrap;
            margin-top: 15px;
        }
        
        .success {
            color: #4ecdc4;
        }
        
        .error {
            color: #ff6b6b;
        }
        
        .warning {
            color: #ffa726;
        }
        
        .info {
            color: #64b5f6;
        }

        .controls {
            background: rgba(255,255,255,0.1);
            backdrop-filter: blur(15px);
            border-radius: 20px;
            padding: 30px;
            margin-bottom: 40px;
            border: 1px solid rgba(255,255,255,0.2);
            box-shadow: 0 8px 32px rgba(0,0,0,0.1);
        }
        
        .search-box {
            width: 100%;
            max-width: 600px;
            margin: 0 auto 30px;
            display: block;
            padding: 18px 25px;
            border: none;
            border-radius: 30px;
            font-size: 16px;
            background: rgba(255,255,255,0.95);
            box-shadow: 0 4px 20px rgba(0,0,0,0.1);
            outline: none;
            transition: all 0.3s ease;
        }
        
        .filter-section {
            margin-bottom: 25px;
        }
        
        .filter-title {
            color: rgba(255,255,255,0.9);
            font-size: 16px;
            font-weight: 600;
            margin-bottom: 12px;
            text-transform: uppercase;
            letter-spacing: 1px;
        }
        
        .filter-group {
            display: flex;
            flex-wrap: wrap;
            gap: 12px;
            justify-content: center;
        }
        
        .filter-btn {
            background: rgba(255,255,255,0.15);
            color: rgba(255,255,255,0.9);
            border: 2px solid rgba(255,255,255,0.3);
            padding: 12px 24px;
            border-radius: 25px;
            cursor: pointer;
            transition: all 0.3s ease;
            font-size: 14px;
            font-weight: 500;
            text-transform: capitalize;
            min-width: 120px;
            text-align: center;
        }
        
        .filter-btn:hover {
            background: rgba(255,255,255,0.25);
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(0,0,0,0.2);
        }
        
        .filter-btn.active {
            background: rgba(255,255,255,0.9);
            color: #667eea;
            border-color: rgba(255,255,255,0.9);
            font-weight: 600;
        }
        
        .stats {
            text-align: center;
            color: rgba(255,255,255,0.8);
            margin: 20px 0;
            font-size: 14px;
            font-weight: 300;
        }
        
        .rules-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(380px, 1fr));
            gap: 30px;
            margin-top: 30px;
        }
        
        .rule-card {
            background: rgba(255,255,255,0.95);
            border-radius: 20px;
            padding: 30px;
            box-shadow: 0 10px 40px rgba(0,0,0,0.1);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255,255,255,0.3);
            transition: all 0.4s ease;
            position: relative;
            overflow: hidden;
        }
        
        .rule-card:hover {
            transform: translateY(-8px);
            box-shadow: 0 20px 50px rgba(0,0,0,0.15);
        }
        
        .rule-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 5px;
            background: linear-gradient(90deg, #667eea, #764ba2);
        }
        
        .tags-container {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
            margin-bottom: 20px;
        }
        
        .tag {
            display: inline-block;
            padding: 6px 12px;
            border-radius: 15px;
            font-size: 11px;
            font-weight: bold;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }
        
        .tag.area {
            background: linear-gradient(135deg, #ff6b6b, #ee5a52);
            color: white;
        }
        
        .tag.discipline {
            background: linear-gradient(135deg, #4ecdc4, #44a08d);
            color: white;
        }
        
        .tag.skill {
            background: linear-gradient(135deg, #45b7d1, #96c93d);
            color: white;
        }
        
        .rule-title {
            font-size: 1.4rem;
            font-weight: 700;
            color: #2c3e50;
            margin-bottom: 15px;
            line-height: 1.3;
        }
        
        .rule-description {
            color: #5a6c7d;
            line-height: 1.7;
            font-size: 14px;
            text-align: justify;
            margin-bottom: 15px;
            display: none;
        }
        
        .read-more-btn {
            background: linear-gradient(135deg, #667eea, #764ba2);
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 20px;
            cursor: pointer;
            font-size: 13px;
            font-weight: 500;
            transition: all 0.3s ease;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }
        
        .read-more-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 15px rgba(102, 126, 234, 0.4);
        }
        
        .read-more-btn.collapse {
            background: linear-gradient(135deg, #ff6b6b, #ee5a52);
        }
        
        .no-results {
            text-align: center;
            color: rgba(255,255,255,0.8);
            font-size: 1.4rem;
            margin-top: 80px;
            display: none;
            padding: 40px;
            background: rgba(255,255,255,0.1);
            border-radius: 20px;
            backdrop-filter: blur(10px);
        }
        
        .reset-filters {
            display: block;
            margin: 20px auto;
            background: rgba(255,255,255,0.2);
            color: white;
            border: 2px solid rgba(255,255,255,0.4);
            padding: 12px 30px;
            border-radius: 25px;
            cursor: pointer;
            transition: all 0.3s ease;
            font-size: 14px;
            font-weight: 500;
        }
        
        .reset-filters:hover {
            background: rgba(255,255,255,0.3);
            transform: translateY(-2px);
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>üîç Diagnostic Mode</h1>
            <p class="subtitle">Let's debug your Google Apps Script connection</p>
        </div>
        
        <div class="diagnostic-panel">
            <h2 class="diagnostic-title">üõ†Ô∏è Connection Diagnostics</h2>
            
            <div class="test-section">
                <h3>üìù Enter Your Google Apps Script URL</h3>
                <input type="text" id="scriptUrl" class="url-input" 
                       placeholder="https://script.google.com/macros/s/YOUR_SCRIPT_ID/exec"
                       value="https://script.google.com/macros/s/AKfycbwG-29xM9l9T3qjeXleQkeNa_zLx73UPD3ZQtxbXyljWJKI79q8S0ccrhpyB-nzyyI/exec">
                <br>
                <button class="btn" onclick="testDirectFetch()">üîÑ Test Direct Fetch</button>
                <button class="btn secondary" onclick="testJSONP()">üì° Test JSONP</button>
                <button class="btn secondary" onclick="testCORS()">üåê Test CORS</button>
                <button class="btn secondary" onclick="clearLog()">üßπ Clear Log</button>
            </div>
            
            <div class="test-section">
                <h3>üìä Test Results</h3>
                <div id="testResults" class="log">Ready to test your Google Apps Script connection...</div>
            </div>
        </div>

        <div class="controls" id="appControls" style="display: none;">
            <input type="text" id="searchBox" class="search-box" placeholder="Search rules by title or content...">
            
            <div class="filter-section">
                <div class="filter-title">Area</div>
                <div class="filter-group" id="areaFilters"></div>
            </div>
            
            <div class="filter-section">
                <div class="filter-title">Discipline</div>
                <div class="filter-group" id="disciplineFilters"></div>
            </div>
            
            <div class="filter-section">
                <div class="filter-title">Skill</div>
                <div class="filter-group" id="skillFilters"></div>
            </div>
            
            <button class="reset-filters" onclick="resetAllFilters()">üîÑ Reset All Filters</button>
            
            <div class="stats" id="stats"></div>
        </div>
        
        <div class="rules-grid" id="rulesGrid"></div>
        <div class="no-results" id="noResults">
            <h3>No rules found matching your criteria.</h3>
            <p>Try adjusting your search or filters.</p>
        </div>
    </div>

    <script>
        let rulesData = [];
        let filteredRules = [];
        let activeFilters = { area: 'all', discipline: 'all', skill: 'all' };
        
        function log(message, type = 'info') {
            const logger = document.getElementById('testResults');
            const timestamp = new Date().toLocaleTimeString();
            const className = type; // success, error, warning, info
            logger.innerHTML += `<span class="${className}">[${timestamp}] ${message}</span>\n`;
            logger.scrollTop = logger.scrollHeight;
            console.log(`[${type.toUpperCase()}] ${message}`);
        }
        
        function clearLog() {
            document.getElementById('testResults').innerHTML = 'Log cleared.\n';
        }
        
        async function testDirectFetch() {
            const url = document.getElementById('scriptUrl').value.trim();
            
            if (!url) {
                log('‚ùå Please enter a Google Apps Script URL', 'error');
                return;
            }
            
            log('üöÄ Testing direct fetch request...', 'info');
            log(`üìç URL: ${url}`, 'info');
            
            try {
                const startTime = Date.now();
                const response = await fetch(url, {
                    method: 'GET',
                    mode: 'cors'
                });
                
                const endTime = Date.now();
                log(`‚è±Ô∏è  Request completed in ${endTime - startTime}ms`, 'info');
                log(`üìä Status: ${response.status} ${response.statusText}`, response.ok ? 'success' : 'error');
                log(`üè∑Ô∏è  Content-Type: ${response.headers.get('content-type')}`, 'info');
                
                if (response.ok) {
                    const text = await response.text();
                    log(`üìè Response length: ${text.length} characters`, 'info');
                    log(`üîç First 200 chars: ${text.substring(0, 200)}...`, 'info');
                    
                    try {
                        const data = JSON.parse(text);
                        log('‚úÖ JSON parsing successful!', 'success');
                        log(`üìä Data type: ${Array.isArray(data) ? 'Array' : typeof data}`, 'info');
                        
                        if (Array.isArray(data)) {
                            log(`üìã Array length: ${data.length}`, 'success');
                            if (data.length > 0) {
                                log(`üîë First item keys: ${Object.keys(data[0]).join(', ')}`, 'info');
                                
                                // Load the data into the app
                                rulesData = data;
                                filteredRules = [...rulesData];
                                document.getElementById('appControls').style.display = 'block';
                                init();
                                log('üéâ Data loaded into application!', 'success');
                            }
                        }
                    } catch (jsonError) {
                        log(`‚ùå JSON parsing failed: ${jsonError.message}`, 'error');
                        log('üìù This might indicate HTML error page or incorrect response format', 'warning');
                    }
                } else {
                    const errorText = await response.text();
                    log(`‚ùå Request failed: ${errorText}`, 'error');
                }
                
            } catch (error) {
                log(`‚ùå Fetch error: ${error.message}`, 'error');
                
                if (error.message.includes('CORS')) {
                    log('üí° CORS error detected - try the JSONP test instead', 'warning');
                } else if (error.message.includes('Failed to fetch')) {
                    log('üí° Network error - check your internet connection and URL', 'warning');
                }
            }
        }
        
        function testJSONP() {
            const url = document.getElementById('scriptUrl').value.trim();
            
            if (!url) {
                log('‚ùå Please enter a Google Apps Script URL', 'error');
                return;
            }
            
            log('üì° Testing JSONP request...', 'info');
            
            const callbackName = 'jsonp_callback_' + Math.round(100000 * Math.random());
            const timeoutId = setTimeout(() => {
                log('‚è∞ JSONP request timeout (10s)', 'error');
                cleanup();
            }, 10000);
            
            const script = document.createElement('script');
            
            window[callbackName] = function(data) {
                log('‚úÖ JSONP callback received!', 'success');
                log(`üìä Data type: ${Array.isArray(data) ? 'Array' : typeof data}`, 'info');
                
                if (Array.isArray(data)) {
                    log(`üìã Array length: ${data.length}`, 'success');
                    if (data.length > 0) {
                        log(`üîë First item keys: ${Object.keys(data[0]).join(', ')}`, 'info');
                        
                        // Load the data into the app
                        rulesData = data;
                        filteredRules = [...rulesData];
                        document.getElementById('appControls').style.display = 'block';
                        init();
                        log('üéâ Data loaded into application via JSONP!', 'success');
                    }
                }
                cleanup();
            };
            
            function cleanup() {
                clearTimeout(timeoutId);
                if (script.parentNode) {
                    script.parentNode.removeChild(script);
                }
                delete window[callbackName];
            }
            
            script.onerror = function(error) {
                log('‚ùå JSONP script loading failed', 'error');
                cleanup();
            };
            
            const scriptUrl = `${url}?callback=${callbackName}&_=${Date.now()}`;
            log(`üìç JSONP URL: ${scriptUrl}`, 'info');
            
            script.src = scriptUrl;
            document.head.appendChild(script);
        }
        
        async function testCORS() {
            const url = document.getElementById('scriptUrl').value.trim();
            
            if (!url) {
                log('‚ùå Please enter a Google Apps Script URL', 'error');
                return;
            }
            
            log('üåê Testing CORS preflight...', 'info');
            
            try {
                const response = await fetch(url, {
                    method: 'OPTIONS'
                });
                
                log(`üìä Preflight status: ${response.status}`, 'info');
                log(`üîì Access-Control-Allow-Origin: ${response.headers.get('access-control-allow-origin')}`, 'info');
                log(`üìù Access-Control-Allow-Methods: ${response.headers.get('access-control-allow-methods')}`, 'info');
                
            } catch (error) {
                log(`‚ùå CORS test error: ${error.message}`, 'error');
            }
        }

        // Main application functions (same as before)
        function init() {
            createFilters();
            render();
            updateStats();
            document.getElementById('searchBox').addEventListener('input', applyFilters);
        }

        function createFilters() {
            // Get unique values from actual data
            const areas = ['all', ...new Set(rulesData.map(rule => rule.area.toLowerCase()))];
            const disciplines = ['all', ...new Set(rulesData.map(rule => rule.discipline.toLowerCase()))];
            const skills = ['all', ...new Set(rulesData.map(rule => rule.skill.toLowerCase()))];

            document.getElementById('areaFilters').innerHTML = areas.map(area => 
                `<button class="filter-btn ${area === 'all' ? 'active' : ''}" onclick="filterByArea('${area}')">
                    ${area === 'all' ? 'All Areas' : area}
                </button>`
            ).join('');

            document.getElementById('disciplineFilters').innerHTML = disciplines.map(discipline => 
                `<button class="filter-btn ${discipline === 'all' ? 'active' : ''}" onclick="filterByDiscipline('${discipline}')">
                    ${discipline === 'all' ? 'All Disciplines' : discipline}
                </button>`
            ).join('');

            document.getElementById('skillFilters').innerHTML = skills.map(skill => 
                `<button class="filter-btn ${skill === 'all' ? 'active' : ''}" onclick="filterBySkill('${skill}')">
                    ${skill === 'all' ? 'All Skills' : skill}
                </button>`
            ).join('');
        }

        function filterByArea(area) {
            activeFilters.area = area;
            updateButtons('areaFilters', area);
            applyFilters();
        }

        function filterByDiscipline(discipline) {
            activeFilters.discipline = discipline;
            updateButtons('disciplineFilters', discipline);
            applyFilters();
        }

        function filterBySkill(skill) {
            activeFilters.skill = skill;
            updateButtons('skillFilters', skill);
            applyFilters();
        }

        function updateButtons(containerId, activeValue) {
            const container = document.getElementById(containerId);
            container.querySelectorAll('.filter-btn').forEach(btn => {
                btn.classList.remove('active');
                if (btn.textContent.toLowerCase().includes(activeValue === 'all' ? 'all' : activeValue.toLowerCase())) {
                    btn.classList.add('active');
                }
            });
        }

        function resetAllFilters() {
            activeFilters = { area: 'all', discipline: 'all', skill: 'all' };
            document.getElementById('searchBox').value = '';
            document.querySelectorAll('.filter-btn').forEach(btn => {
                btn.classList.toggle('active', btn.textContent.toLowerCase().includes('all'));
            });
            applyFilters();
        }

        function applyFilters() {
            const searchTerm = document.getElementById('searchBox').value.toLowerCase();
            
            filteredRules = rulesData.filter(rule => {
                const matchesSearch = !searchTerm || 
                    rule.title.toLowerCase().includes(searchTerm) || 
                    rule.fullDescription.toLowerCase().includes(searchTerm);

                const matchesArea = activeFilters.area === 'all' || 
                    rule.area.toLowerCase().includes(activeFilters.area.toLowerCase());

                const matchesDiscipline = activeFilters.discipline === 'all' ||
                    rule.discipline.toLowerCase() === activeFilters.discipline.toLowerCase();

                const matchesSkill = activeFilters.skill === 'all' ||
                    rule.skill.toLowerCase() === activeFilters.skill.toLowerCase();
                
                return matchesSearch && matchesArea && matchesDiscipline && matchesSkill;
            });
            
            render();
            updateStats();
        }

        function render() {
            const grid = document.getElementById('rulesGrid');
            const noResults = document.getElementById('noResults');
            
            if (filteredRules.length === 0) {
                grid.style.display = 'none';
                noResults.style.display = 'block';
            } else {
                grid.style.display = 'grid';
                noResults.style.display = 'none';
                
                grid.innerHTML = filteredRules.map((rule, index) => {
                    const areas = rule.area.split(';').map(a => a.trim());
                    const areaTag = areas[0];
                    
                    return `
                        <div class="rule-card">
                            <div class="tags-container">
                                <span class="tag area">${areaTag}</span>
                                <span class="tag discipline">${rule.discipline}</span>
                                <span class="tag skill">${rule.skill}</span>
                            </div>
                            <h3 class="rule-title">${rule.title}</h3>
                            <div class="rule-description" id="desc-${index}">
                                ${rule.fullDescription}
                            </div>
                            <button class="read-more-btn" onclick="toggle(${index})" id="btn-${index}">
                                Read More
                            </button>
                        </div>
                    `;
                }).join('');
            }
        }

        function toggle(index) {
            const desc = document.getElementById(`desc-${index}`);
            const btn = document.getElementById(`btn-${index}`);
            
            if (desc.style.display === 'none' || desc.style.display === '') {
                desc.style.display = 'block';
                btn.textContent = 'Show Less';
                btn.classList.add('collapse');
            } else {
                desc.style.display = 'none';
                btn.textContent = 'Read More';
                btn.classList.remove('collapse');
            }
        }

        function updateStats() {
            document.getElementById('stats').textContent = 
                `Showing ${filteredRules.length} of ${rulesData.length} rules`;
        }
    </script>
</body>
</html>
